# デザイントークン アーキテクチャガイド

**Hidearea Design System Tokens**
**最終更新:** 2025-12-10
**バージョン:** 2.0 (Phase 3完了版)

---

## 概要

Hidearea Design System Tokensは、二層変数アーキテクチャを採用した高度なデザイントークンシステムです。このアーキテクチャにより、テーマの動的な切り替え、保守性の高いトークン管理、スケーラブルなコンポーネントシステムを実現しています。

### 主要な特徴

- ✅ **二層変数システム**: CSS Custom Propertiesを活用した動的テーマ切り替え
- ✅ **3層トークン構造**: Base → Semantic → Component の明確な階層
- ✅ **機能別カテゴリ**: コンポーネントを目的別に整理
- ✅ **YAML統一**: 全てのトークン定義がYAML形式
- ✅ **Style Dictionary 4.0**: 最新のビルドシステム

---

## トークンアーキテクチャ

### 3層構造の概要

Hideareaのデザイントークンは、以下の3つの明確な層で構成されています：

```
┌─────────────────────────────────────────┐
│  Layer 3: Component Tokens              │
│  (コンポーネント固有の値)                  │
│  component.button.primary.background    │
└──────────────┬──────────────────────────┘
               │ 参照
┌──────────────▼──────────────────────────┐
│  Layer 2: Semantic Tokens               │
│  (意味的な役割を持つ値)                    │
│  primary.default                        │
└──────────────┬──────────────────────────┘
               │ 参照
┌──────────────▼──────────────────────────┐
│  Layer 1: Base Tokens                   │
│  (プリミティブな値)                        │
│  color.blue.500                         │
└─────────────────────────────────────────┘
```

### Layer 1: Base Tokens (ベーストークン)

**定義場所**: `src/base/**/*.yaml`

プリミティブな値を定義します。色、スペーシング、タイポグラフィなどの基礎的な値がここに含まれます。

**例**: `src/base/colors.yaml`
```yaml
color:
  blue:
    500:
      value: "#3b82f6"
      comment: "プライマリブルー"
  gray:
    50:
      value: "#f9fafb"
      comment: "最も明るいグレー"
    900:
      value: "#111827"
      comment: "最も暗いグレー"
```

**特徴**:
- 具体的な値（HEX、px、remなど）のみを含む
- 他のトークンを参照しない
- テーマに依存しない普遍的な値

### Layer 2: Semantic Tokens (セマンティックトークン)

**定義場所**: `src/semantic/**/*.yaml`

意味的な役割を持つトークンです。ベーストークンを参照し、デザインシステム全体で一貫した意味を持つ名前を付けます。

**例**: `src/semantic/aliases.yaml`
```yaml
primary:
  default:
    value: "{color.blue.500}"
    comment: "プライマリカラーのデフォルト状態"
  hover:
    value: "{color.blue.600}"
    comment: "プライマリカラーのホバー状態"

success:
  default:
    value: "{color.green.500}"
    comment: "成功状態のデフォルト"
  subtle:
    value: "{color.green.50}"
    comment: "成功状態の控えめな背景"
```

**特徴**:
- 役割ベースの命名（primary, success, errorなど）
- ベーストークンを参照
- テーマ切り替えの中間層として機能

### Layer 3: Component Tokens (コンポーネントトークン)

**定義場所**: `src/components/**/*.yaml`

特定のコンポーネント専用のトークンです。セマンティックトークンを参照し、コンポーネントの各部位に明確な名前を付けます。

**例**: `src/components/forms/button.yaml`
```yaml
component:
  button:
    primary:
      background:
        default:
          value: "{primary.default}"
          comment: "プライマリボタンの背景色"
        hover:
          value: "{primary.hover}"
          comment: "ホバー時の背景色"
      text:
        default:
          value: "{color.white}"
          comment: "プライマリボタンのテキスト色"
```

**特徴**:
- コンポーネント固有の命名
- セマンティックトークンを参照
- 状態やバリアントごとに細かく定義

---

## 二層変数システム

### 仕組み

二層変数システムは、CSS Custom Propertiesを2段階で使用することで、テーマの動的な切り替えを実現します。

```css
/* コンポーネント層（第1層） */
--component-button-primary-background-default: var(--primary-default);

/* セマンティック層（第2層） */
--primary-default: var(--theme-light-primary-default, #3b82f6);
```

この構造により、テーマトークンの値を変更するだけで、全てのコンポーネントのスタイルが自動的に更新されます。

### CSS出力の詳細

**1. コンポーネント層のCSS変数**

```css
:root {
  /* コンポーネントトークン → セマンティックエイリアスを参照 */
  --component-button-primary-background-default: var(--primary-default);
  --component-button-primary-background-hover: var(--primary-hover);
  --component-button-primary-text-default: var(--color-white);
}
```

**2. セマンティック層のCSS変数（エイリアス）**

```css
:root {
  /* セマンティックエイリアス → テーマ変数を参照（フォールバック付き） */
  --primary-default: var(--theme-light-primary-default, #3b82f6);
  --primary-hover: var(--theme-light-primary-hover, #2563eb);
  --color-white: #ffffff;
}
```

**3. テーマ層のCSS変数**

```css
/* ライトテーマ */
[data-theme="light"] {
  --theme-light-primary-default: #3b82f6;
  --theme-light-primary-hover: #2563eb;
}

/* ダークテーマ */
[data-theme="dark"] {
  --theme-light-primary-default: #60a5fa;
  --theme-light-primary-hover: #3b82f6;
}
```

### テーマ切り替えの流れ

1. HTMLに `data-theme` 属性を追加
   ```html
   <html data-theme="dark">
   ```

2. CSS変数の解決フロー
   ```
   --component-button-primary-background-default
   → var(--primary-default)
   → var(--theme-light-primary-default, #3b82f6)
   → [data-theme="dark"] の --theme-light-primary-default
   → #60a5fa
   ```

3. 全コンポーネントが自動的に新しいテーマ色を適用

### メリット

1. **動的切り替え**: JavaScriptで属性を変更するだけでテーマ全体が切り替わる
2. **パフォーマンス**: CSSの再計算のみで、再レンダリング不要
3. **保守性**: テーマの定義が一箇所に集約
4. **柔軟性**: カスタムテーマの作成が容易
5. **型安全性**: TypeScript定義も自動生成

---

## ディレクトリ構造

```
packages/tokens/
├── src/
│   ├── base/                    # Layer 1: ベーストークン
│   │   ├── colors.yaml         # カラーパレット
│   │   ├── spacing.yaml        # スペーシングスケール
│   │   ├── typography.yaml     # タイポグラフィ基礎
│   │   ├── border.yaml         # ボーダー幅、半径
│   │   └── shadow.yaml         # シャドウ定義
│   │
│   ├── semantic/                # Layer 2: セマンティックトークン
│   │   ├── aliases.yaml        # セマンティックエイリアス（最重要）
│   │   ├── colors.yaml         # セマンティックカラー
│   │   ├── typography.yaml     # セマンティックタイポグラフィ
│   │   ├── surfaces.yaml       # サーフェス定義
│   │   ├── states.yaml         # 状態トークン
│   │   ├── layout.yaml         # レイアウト
│   │   └── interactions.yaml   # インタラクション
│   │
│   ├── components/              # Layer 3: コンポーネントトークン
│   │   ├── forms/              # フォーム関連
│   │   │   ├── button.yaml
│   │   │   └── input.yaml
│   │   ├── feedback/           # フィードバック表示
│   │   │   ├── badge.yaml
│   │   │   └── alert.yaml
│   │   ├── overlays/           # オーバーレイ系
│   │   │   ├── modal.yaml
│   │   │   └── tooltip.yaml
│   │   ├── data-display/       # データ表示
│   │   │   ├── card.yaml
│   │   │   └── table.yaml
│   │   └── navigation/         # ナビゲーション
│   │       └── navigation.yaml
│   │
│   └── themes/                  # テーマ定義
│       ├── light/
│       │   └── colors.yaml     # ライトテーマの色定義
│       └── dark/
│           └── colors.yaml     # ダークテーマの色定義
│
├── build/                       # ビルド出力
│   ├── css/
│   │   └── variables.css       # CSS変数（二層変数）
│   ├── js/
│   │   └── index.js           # JavaScript/JSON出力
│   └── ts/
│       └── index.d.ts         # TypeScript型定義
│
├── config.mjs                   # Style Dictionary設定
└── docs/                        # ドキュメント（このファイル）
```

---

## ビルドシステム

### Style Dictionary 4.0

Hideareaは、Style Dictionary 4.0を使用してトークンをビルドします。

**設定ファイル**: `config.mjs`

```javascript
export default {
  source: [
    'src/base/**/*.yaml',
    'src/semantic/**/*.yaml',
    'src/components/**/*.yaml',
    'src/themes/**/*.yaml'
  ],
  platforms: {
    css: {
      transformGroup: 'css',
      buildPath: 'build/css/',
      files: [{
        destination: 'variables.css',
        format: 'css/variables'
      }]
    },
    js: {
      transformGroup: 'js',
      buildPath: 'build/js/',
      files: [{
        destination: 'index.js',
        format: 'javascript/es6'
      }]
    }
  }
};
```

### ビルドコマンド

```bash
# トークンをビルド
pnpm build

# 開発モード（ウォッチ）
pnpm build:watch

# バンドルサイズを測定
pnpm measure:size
```

### カスタムトランスフォーム

二層変数システムを実現するため、カスタムトランスフォームを使用しています：

```javascript
// セマンティックエイリアスを二層変数に変換
StyleDictionary.registerTransform({
  name: 'css/semantic-alias',
  type: 'value',
  matcher: (token) => token.path[0] !== 'component',
  transformer: (token) => {
    // {primary.default} → var(--theme-light-primary-default, #3b82f6)
    return transformToThemeVariable(token.value);
  }
});
```

---

## テーマシステム

### テーマの定義

テーマは `src/themes/` ディレクトリで定義します。

**ライトテーマ**: `src/themes/light/colors.yaml`
```yaml
theme:
  light:
    primary:
      default:
        value: "{color.blue.500}"
      hover:
        value: "{color.blue.600}"

    background:
      primary:
        value: "{color.white}"
      secondary:
        value: "{color.gray.50}"
```

**ダークテーマ**: `src/themes/dark/colors.yaml`
```yaml
theme:
  dark:
    primary:
      default:
        value: "{color.blue.400}"
      hover:
        value: "{color.blue.500}"

    background:
      primary:
        value: "{color.gray.900}"
      secondary:
        value: "{color.gray.800}"
```

### テーマの適用

HTMLに `data-theme` 属性を追加するだけで、テーマが切り替わります。

```html
<!DOCTYPE html>
<html data-theme="light">
  <head>
    <link rel="stylesheet" href="variables.css">
  </head>
  <body>
    <button class="button-primary">Click me</button>
  </body>
</html>
```

JavaScriptでの切り替え：

```javascript
// ライトテーマに切り替え
document.documentElement.setAttribute('data-theme', 'light');

// ダークテーマに切り替え
document.documentElement.setAttribute('data-theme', 'dark');

// システム設定に従う
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
document.documentElement.setAttribute(
  'data-theme',
  prefersDark.matches ? 'dark' : 'light'
);
```

---

## 命名規則

### トークン命名パターン

```
{layer}.{category}.{component?}.{property}.{variant?}.{state?}
```

**例**:
- `color.blue.500` - Base token
- `primary.default` - Semantic token
- `component.button.primary.background.hover` - Component token

### 命名ガイドライン

1. **ケバブケース**: 全て小文字、ハイフン区切り
2. **意味的な名前**: 役割を明確に示す
3. **階層的**: 親子関係が明確
4. **一貫性**: 同じパターンを全体で適用

### 状態の命名

```yaml
default:   # デフォルト状態
hover:     # ホバー時
focus:     # フォーカス時
active:    # アクティブ時
disabled:  # 無効時
error:     # エラー時
success:   # 成功時
```

---

## コンポーネントカテゴリ

コンポーネントは機能別に5つのカテゴリに分類されています。

### 1. Forms (フォーム)

ユーザー入力を受け付けるコンポーネント

**実装済み**:
- `button.yaml` - ボタン（4バリアント）
- `input.yaml` - テキスト入力

**今後追加予定**:
- checkbox, radio, select, textarea, switch

### 2. Feedback (フィードバック)

ユーザーへの通知や状態表示

**実装済み**:
- `badge.yaml` - バッジ（4バリアント）
- `alert.yaml` - アラート（4バリアント）

**今後追加予定**:
- toast, progress, skeleton

### 3. Overlays (オーバーレイ)

画面上に重なって表示される要素

**実装済み**:
- `modal.yaml` - モーダル
- `tooltip.yaml` - ツールチップ

**今後追加予定**:
- dialog, drawer, popover, dropdown

### 4. Data Display (データ表示)

データを表示するコンポーネント

**実装済み**:
- `card.yaml` - カード
- `table.yaml` - テーブル

**今後追加予定**:
- list, avatar, chip

### 5. Navigation (ナビゲーション)

ページ間やセクション間の移動

**実装済み**:
- `navigation.yaml` - ナビゲーション

**今後追加予定**:
- tabs, breadcrumb, pagination

---

## ベストプラクティス

### 1. トークンの参照

✅ **推奨**: セマンティックトークンを参照
```yaml
component:
  button:
    primary:
      background:
        default:
          value: "{primary.default}"  # Good
```

❌ **非推奨**: ベーストークンを直接参照
```yaml
component:
  button:
    primary:
      background:
        default:
          value: "{color.blue.500}"  # Bad - 中間層をスキップ
```

### 2. コメントの記述

全てのトークンに意味を説明するコメントを付けます。

```yaml
primary:
  default:
    value: "{color.blue.500}"
    comment: "プライマリカラーのデフォルト状態。ブランドを表す主要な色。"
```

### 3. テーマ対応

新しいトークンを追加する際は、必ず両方のテーマで定義します。

```yaml
# themes/light/colors.yaml
theme:
  light:
    new-color:
      value: "{color.blue.500}"

# themes/dark/colors.yaml
theme:
  dark:
    new-color:
      value: "{color.blue.400}"  # ダークテーマでは明るめに
```

### 4. バリアントの統一

同じ種類のバリアントは、全コンポーネントで統一します。

```yaml
# フィードバック系は4バリアント: success, error, warning, info
# ボタン系は4バリアント: primary, secondary, ghost, danger
```

---

## トラブルシューティング

### ビルドエラー

**問題**: `Token not found: {primary.default}`

**原因**: 参照しているトークンが定義されていない

**解決**:
1. `src/semantic/aliases.yaml` に該当トークンが存在するか確認
2. タイポがないか確認
3. ビルド順序を確認（baseより先にsemanticは読み込めない）

### テーマが切り替わらない

**問題**: `data-theme` を変更してもスタイルが変わらない

**原因**: テーマトークンが正しく定義されていない

**解決**:
1. ブラウザの開発者ツールでCSS変数の値を確認
2. `[data-theme="dark"]` セレクタが正しく適用されているか確認
3. フォールバック値が使用されていないか確認

### パフォーマンス問題

**問題**: ビルドが遅い

**解決**:
1. 不要なトークンファイルを削除
2. `source` パターンを最適化
3. キャッシュを利用（`.buildcache/`）

---

## まとめ

Hidearea Design System Tokensの二層変数アーキテクチャは、以下の利点を提供します：

1. **動的テーマ切り替え**: ランタイムでのテーマ変更が可能
2. **保守性**: トークンの階層が明確で、変更の影響範囲が限定的
3. **スケーラビリティ**: 新しいコンポーネントやテーマの追加が容易
4. **開発体験**: TypeScript型定義による補完とエラー検出
5. **パフォーマンス**: CSS変数のネイティブ機能を活用

このアーキテクチャを理解することで、効率的にデザイントークンを管理し、一貫性のあるUIを構築できます。

---

**関連ドキュメント**:
- [使用方法ガイド](./使用方法ガイド.md)
- [コンポーネントリファレンス](./components/)
- [移行ガイド](./移行ガイド.md)
